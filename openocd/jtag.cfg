# OpenOCD configuration for JTAG mode testing
# Usage: openocd -f openocd/jtag.cfg

# VPI adapter configuration
adapter driver jtag_vpi
jtag_vpi set_port 3333
jtag_vpi set_address 127.0.0.1

# Transport selection (must be after adapter driver)
transport select jtag

# Adapter speed (kHz)
adapter speed 1000

# GDB server port (separate from VPI port 3333)
gdb port 3334

# Define the TAP
# -irlen: Instruction register length (5 bits for RISC-V DTM)
# -expected-id: Expected IDCODE value
jtag newtap riscv cpu -irlen 5 -expected-id 0x1dead3ff

# Create target
set _TARGETNAME riscv.cpu
target create $_TARGETNAME riscv -chain-position $_TARGETNAME

# RISC-V specific configuration
riscv set_ir dtmcs 0x10
riscv set_ir dmi   0x11
riscv set_mem_access progbuf sysbus abstract
riscv set_command_timeout_sec 10

# Initialize
init

# Inspect the scan chain
scan_chain

echo "OpenOCD initialized in JTAG mode"
echo "IDCODE: 0x1dead3ff"
echo "Connect via: telnet localhost 4444"
