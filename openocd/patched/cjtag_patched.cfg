# OpenOCD Configuration with cJTAG/OScan1 Support
# This configuration requires the patched OpenOCD with oscan1.c support
# 
# Usage: openocd -f openocd/patched/cjtag_patched.cfg

# VPI Adapter Configuration
adapter driver jtag_vpi
jtag_vpi set_port 3333

# ============================================
# cJTAG/OScan1 Mode Configuration
# ============================================

# Enable cJTAG/OScan1 two-wire mode
# This will initialize the OScan1 protocol:
# - Send OAC (Attention Character)
# - Send JSCAN_OSCAN_ON
# - Select device
# - Select Scanning Format 0
jtag_vpi enable_cjtag

# Configure scanning format (optional)
# SF0 = Standard format (default)
# SF1 = Optimized format
# SF2 = Advanced format
# SF3 = High-speed format
jtag_vpi scanning_format 0

# Enable error detection (optional)
# CRC-8 polynomial: x^8 + x^2 + x + 1
jtag_vpi enable_crc on

# Enable parity checking (optional)
# Even parity on JScan commands
jtag_vpi enable_parity on

# ============================================
# Transport and Target Configuration
# ============================================

# Transport selection
# Note: cJTAG still uses JTAG transport layer
# but communicates over two-wire interface
transport select jtag

# Adapter speed (kHz)
# Note: cJTAG OScan1 may have different timing requirements
adapter speed 1000

# Reset configuration
reset_config none

# ============================================
# TAP Configuration
# ============================================

# Define JTAG TAP for RISC-V target
# IDCODE: 0x1DEAD3FF (from hardware)
jtag newtap riscv cpu -irlen 5 -expected-id 0x1dead3ff

# ============================================
# Target Configuration
# ============================================

# Create RISC-V target
target create riscv.cpu riscv -chain-position riscv.cpu

# Configure RISC-V Debug Module Interface (DMI)
riscv set_ir dtmcs 0x10
riscv set_ir dmi 0x11

# Memory access settings
riscv set_mem_access abstract

# Enable command logging for debugging
riscv set_command_timeout_sec 10

# ============================================
# Initialization
# ============================================

init

echo "=================================================="
echo "OpenOCD cJTAG/OScan1 Configuration Loaded"
echo "=================================================="
echo "Mode:            cJTAG (IEEE 1149.7 OScan1)"
echo "Interface:       Two-wire (TCKC/TMSC)"
echo "Scanning Format: SF0"
echo "Target:          RISC-V with Debug Module"
echo "IDCODE:          0x1DEAD3FF"
echo "=================================================="

# Verify connection by reading IDCODE
echo "Verifying connection..."
scan_chain
